# CodeRabbit configuration for nostr.blue
# A Nostr protocol client built with Rust and Dioxus
# Save this as .coderabbit.yml in the root of your repository

language: "en"
early_access: false

reviews:
  # Disables the workflow where CodeRabbit requests changes.
  request_changes_workflow: false

  # Enables a high-level summary on pull requests.
  high_level_summary: true

  # Generates a poem about the changes.
  poem: true

  # Adds a review status comment.
  review_status: true

  # Keeps the detailed file-by-file walkthrough expanded.
  collapse_walkthrough: false

  # Abort review if PR is closed during review
  abort_on_close: true

  # Filters to exclude files from review.
  path_filters:
    # Build artifacts and dependencies
    - "!**/target/**"
    - "!**/dist/**"
    - "!**/node_modules/**"
    - "!**/package-lock.json"
    - "!**/Cargo.lock"

    # Configuration files that rarely need review
    - "!**/*.toml"
    - "!**/*.md"
    - "!.gitignore"
    - "!LICENSE"
    - "!**/.env*"
    - "!**/tailwind.config.js"

    # C bindings (if any) and build scripts
    - "!**/*.c"
    - "!**/CMakeLists.txt"
    - "!**/build.rs"

    # Generated files
    - "!**/public/tailwind.css"

  # Provides specific instructions for matching paths.
  path_instructions:
    - path: "**/*.rs"
      instructions: |
        You are @coderabbitai, a language model trained by OpenAI.
        Your purpose is to function as a very experienced **Rust software engineer** with deep expertise in:
        - **Nostr Protocol**: NIPs (Nostr Implementation Possibilities), event types, relay communication, and cryptographic signatures
        - **WebAssembly (WASM)**: Browser-based Rust applications, WASM-bindgen patterns, and performance considerations
        - **Dioxus Framework**: Component patterns, reactive state management, hooks, and routing
        - **Async Rust**: Tokio runtime, async/await patterns, futures, and concurrency primitives
        - **Cashu/Ecash Protocol**: CDK (Cashu Development Kit) integration, mint/melt operations, quote lifecycle, blind signatures, and proof management
        - **Browser Storage**: IndexedDB patterns for persistent state, atomic transactions, and database trait implementations

        Thoroughly review the code snippets and suggest improvements for these key areas:
          - **Logic**: Flaws in program logic, edge cases, and algorithmic correctness.
          - **Security**: Vulnerabilities, especially:
            - Nostr event validation and signature verification
            - XSS risks in user-generated content rendering
            - Relay communication and untrusted data handling
            - Cryptographic operations and key management
            - LocalStorage/IndexedDB data exposure
          - **Performance**: Bottlenecks, inefficient algorithms, or unnecessary allocations, especially:
            - WASM binary size optimizations
            - Unnecessary clones or allocations
            - Database query efficiency (nostr-indexeddb and IndexedDB for CDK wallet)
            - Rendering performance in Dioxus components
            - Atomic IndexedDB transactions for wallet operations
          - **Concurrency**: Potential data races, deadlocks, improper use of async/await, or channel misuse.
          - **Nostr Protocol Compliance**: Correct implementation of NIPs, event structure, and relay communication patterns.
          - **Cashu Protocol Compliance**: Proper CDK trait implementations, quote lifecycle management, keyset counter atomicity, and blind signature handling.
          - **Database Correctness**: Atomic transactions for wallet operations, proper quote cleanup, counter persistence across page refresh, and race condition prevention.
          - **WASM Best Practices**: Efficient JavaScript interop, memory management, avoiding panics, and Send+Sync safety in single-threaded contexts.
          - **Dioxus Patterns**: Proper use of hooks, memo, signals, and component lifecycle.
          - **Error Handling**: Proper use of Result/Option, error propagation, quote cleanup on failures, and user-facing error messages.
          - **Maintainability & Modularity**: Code that is overly complex, monolithic, or violates separation of concerns.
          - **Best Practices**: Adherence to Rust idioms (ownership, lifetimes, zero-cost abstractions) and SOLID/KISS principles.

        Please **do not** comment on:
          - Trivial code style issues or formatting (handled by rustfmt)
          - Missing comments unless they obscure critical logic
          - Naming conventions unless they're misleading

        Focus on identifying and solving significant problems that improve code quality, security, and performance.

    - path: "**/Cargo.toml"
      instructions: |
        Review dependency versions, feature flags, and configurations:
          - Check for outdated or vulnerable dependencies
          - Verify feature flags are minimal and necessary
          - Ensure profile settings (release/dev) are optimal
          - Flag any suspicious or unnecessary dependencies
        Only comment on significant issues, not minor version updates.

    - path: "**/*.js"
      instructions: |
        Review JavaScript configuration files (like tailwind.config.js):
          - Check for security issues in build configurations
          - Verify paths and settings are correct
          - Flag any unnecessary complexity
        Keep comments minimal and focus on actual issues.

    - path: "**/index.html"
      instructions: |
        Review HTML entry point for:
          - Security: CSP headers, script integrity, XSS prevention
          - Performance: Resource loading strategy, critical CSS
          - Accessibility: Semantic HTML, ARIA attributes
          - SEO: Meta tags, Open Graph, structured data

  # Auto-review configuration
  auto_review:
    # Enable auto-review for pull requests.
    enabled: true

    # Do not review PRs with these keywords in the title.
    ignore_title_keywords:
      - "WIP"
      - "DO NOT MERGE"
      - "DRAFT"
      - "POC"

    # Do not review draft pull requests.
    drafts: false

    # Auto-review PRs targeting these base branches (regex patterns).
    base_branches:
      - "main"
      - "master"
      - "develop"
      - "^feature/.*"
      - "^up/.*"
      - "^release/.*"

    # Only review if certain labels are present (optional - comment out if not needed)
    # labels:
    #   - "ready-for-review"
    #   - "needs-review"

chat:
  # Allow CodeRabbit to auto-reply in chat.
  auto_reply: true

# Configure knowledge base for project-specific context
knowledge_base:
  # Learnings that CodeRabbit should remember about this project
  learnings:
    - "This project uses nostr-sdk 0.44 with specific NIPs enabled, including NIP-60 for Cashu wallet integration"
    - "Performance is critical - watch for WASM binary size increases and unnecessary allocations"
    - "All user content must be sanitized with ammonia before rendering to prevent XSS"
    - "Cashu wallet uses CDK 0.13.4 with custom IndexedDB implementation of WalletDatabase trait"
    - "Keyset counters MUST be atomic and persistent to prevent 'Blinded Message already signed' errors"
    - "Quote lifecycle: create → poll payment → mint/melt → cleanup. Always clean up quotes on failure or success"
    - "IndexedDB operations in WASM are single-threaded but require unsafe Send+Sync impls for trait compatibility"
    - "Deterministic seed derivation from Nostr key means counter persistence is CRITICAL for preventing duplicate blinded messages"
    - "Multi-step wallet operations (Lightning deposits/withdrawals) must survive page refresh via IndexedDB"
    - "Database has 9 object stores: mints, keysets, keyset_by_id, keys, mint_quotes, melt_quotes, proofs, transactions, keyset_counters"

# Configure tools and integrations
tools:
  # Enable GitHub Actions integration
  github_actions: true
  # Enable AST-based analysis
  ast_analysis: true
